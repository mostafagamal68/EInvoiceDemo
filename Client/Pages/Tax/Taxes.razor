@page "/Taxes"
@inherits GeneralComponent
@inject IGenericService<TaxesFilter, TaxDto> taxes

<div class="text-end my-1">
    <Btn class="btn-violet" Text="Add" Icon="bi bi-plus-circle"
         ClickAction="@(() => ShowModal(typeof(Tax), $"Add - {nameof(Tax)}", afterClose: GetTaxesFiltered))" />
</div>
<div class="d-flex justify-content-start flex-wrap gap-2 my-1">
    <div>
        <label>Name</label>
        <input class="form-control" @bind="filter.TaxName" @bind:event="oninput" @bind:after="GetTaxesFiltered" />
    </div>
</div>
@if (!LoaderService.IsLoading)
{
    <TableWithPagination TType="TaxDto" Model="filter" Filter="GetTaxesFiltered"
                         Actions="@((args) => TableActions(args.Id, args.IsDelete))">
    </TableWithPagination>
}
@code {
    TaxesFilter filter = new();

    protected override async Task OnInitializedAsync()
    {
        taxes.Api = nameof(Taxes);
        HeaderService.ChangeHeaderAndTitle(nameof(Taxes));
        LoaderService.ToggleLoader();
        await GetTaxesFiltered();
        LoaderService.ToggleLoader();
    }

    private async Task GetTaxesFiltered()
        => filter = await taxes.GetList(filter);

    private async Task TableActions(Guid Id, bool IsDelete)
    {
        if (IsDelete)
        {
            if (await ShowDeleteConfirmation(nameof(Tax)))
            {
                var response = await taxes.Delete(Id);
                if (response.IsSuccessStatusCode)
                    filter.Items.Remove(filter.Items.First(c => c.TaxId == Id));
                await ShowResultMessage(response);
            }
        }
        else
            await ShowModal(
                typeof(Tax),
                $"Edit - {nameof(Tax)}",
                new ModalParameters().Add(nameof(Tax.IsModal), true).Add(nameof(Tax.Id), Id),
                GetTaxesFiltered);
    }
}
